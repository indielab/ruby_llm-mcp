<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(2)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(2) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(3) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(3) > ul > li:nth-child(2) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(3) > ul.nav-list > li.nav-list-item:nth-child(2) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/assets/images/favicon/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Rails Integration | RubyLLM::MCP</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Rails Integration" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Complete Rails integration with generators, configuration, and automatic client management" /> <meta property="og:description" content="Complete Rails integration with generators, configuration, and automatic client management" /> <link rel="canonical" href="http://localhost:4000/guides/rails-integration.html" /> <meta property="og:url" content="http://localhost:4000/guides/rails-integration.html" /> <meta property="og:site_name" content="RubyLLM::MCP" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Rails Integration" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Complete Rails integration with generators, configuration, and automatic client management","headline":"Rails Integration","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/rubyllm-mcp-logo-text.svg"}},"url":"http://localhost:4000/guides/rails-integration.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="RubyLLM::MCP"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/configuration.html" class="nav-list-link">Configuration</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Guides category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/guides/" class="nav-list-link">Guides</a><ul class="nav-list"><li class="nav-list-item"><a href="/guides/getting-started.html" class="nav-list-link">Basics</a></li><li class="nav-list-item"><a href="/guides/rails-integration.html" class="nav-list-link">Rails Integration</a></li><li class="nav-list-item"><a href="/guides/transports.html" class="nav-list-link">Transports</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Server Interactions category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/server/" class="nav-list-link">Server Interactions</a><ul class="nav-list"><li class="nav-list-item"><a href="/server/tools.html" class="nav-list-link">Tools</a></li><li class="nav-list-item"><a href="/server/resources.html" class="nav-list-link">Resources</a></li><li class="nav-list-item"><a href="/server/prompts.html" class="nav-list-link">Prompts</a></li><li class="nav-list-item"><a href="/server/notifications.html" class="nav-list-link">Notifications</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Client Interactions category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/client/" class="nav-list-link">Client Interactions</a><ul class="nav-list"><li class="nav-list-item"><a href="/client/sampling.html" class="nav-list-link">Sampling</a></li><li class="nav-list-item"><a href="/client/roots.html" class="nav-list-link">Roots</a></li><li class="nav-list-item"><a href="/client/elicitation.html" class="nav-list-link">Elicitation</a></li></ul></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/patvice/ruby_llm-mcp" class="nav-list-link external" > Github <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search RubyLLM::MCP" aria-label="Search RubyLLM::MCP" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/guides/">Guides</a></li> <li class="breadcrumb-nav-list-item"><span>Rails Integration</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 class="no_toc" id="rails-integration"> <a href="#rails-integration" class="anchor-heading" aria-labelledby="rails-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Rails Integration </h1> <p>RubyLLM MCP provides seamless Rails integration through generators, automatic client management, and built-in patterns for common Rails use cases.</p> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#installation-and-setup" id="markdown-toc-installation-and-setup">Installation and Setup</a> <ol> <li><a href="#generator-installation" id="markdown-toc-generator-installation">Generator Installation</a></li> <li><a href="#generated-files" id="markdown-toc-generated-files">Generated Files</a> <ol> <li><a href="#configinitializersruby_llm_mcprb" id="markdown-toc-configinitializersruby_llm_mcprb"><code class="language-plaintext highlighter-rouge">config/initializers/ruby_llm_mcp.rb</code></a></li> <li><a href="#configmcpsyml" id="markdown-toc-configmcpsyml"><code class="language-plaintext highlighter-rouge">config/mcps.yml</code></a></li> </ol> </li> </ol> </li> <li><a href="#client-management-strategies" id="markdown-toc-client-management-strategies">Client Management Strategies</a> <ol> <li><a href="#automatic-client-management" id="markdown-toc-automatic-client-management">Automatic Client Management</a></li> <li><a href="#manual-client-management" id="markdown-toc-manual-client-management">Manual Client Management</a></li> </ol> </li> <li><a href="#examples" id="markdown-toc-examples">Examples</a> <ol> <li><a href="#background-job-integration" id="markdown-toc-background-job-integration">Background Job Integration</a></li> <li><a href="#advanced-job-with-progress-tracking" id="markdown-toc-advanced-job-with-progress-tracking">Advanced Job with Progress Tracking</a></li> <li><a href="#controller-integration-for-basic-controller-usage" id="markdown-toc-controller-integration-for-basic-controller-usage">Controller Integration for Basic Controller Usage</a></li> <li><a href="#streaming-controller" id="markdown-toc-streaming-controller">Streaming Controller</a></li> </ol> </li> <li><a href="#next-steps" id="markdown-toc-next-steps">Next Steps</a></li> </ol><hr /> <h2 id="installation-and-setup"> <a href="#installation-and-setup" class="anchor-heading" aria-labelledby="installation-and-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installation and Setup </h2> <h3 id="generator-installation"> <a href="#generator-installation" class="anchor-heading" aria-labelledby="generator-installation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generator Installation </h3> <p>Generate the initial configuration files:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate ruby_llm:mcp:install
</code></pre></div></div> <p>This creates:</p> <ul> <li><code class="language-plaintext highlighter-rouge">config/initializers/ruby_llm_mcp.rb</code> - Main configuration</li> <li><code class="language-plaintext highlighter-rouge">config/mcps.yml</code> - MCP servers configuration</li> </ul> <h3 id="generated-files"> <a href="#generated-files" class="anchor-heading" aria-labelledby="generated-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generated Files </h3> <h4 id="configinitializersruby_llm_mcprb"> <a href="#configinitializersruby_llm_mcprb" class="anchor-heading" aria-labelledby="configinitializersruby_llm_mcprb"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <code class="language-plaintext highlighter-rouge">config/initializers/ruby_llm_mcp.rb</code> </h4> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># Global configuration</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">log_level</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span> <span class="p">?</span> <span class="no">Logger</span><span class="o">::</span><span class="no">WARN</span> <span class="p">:</span> <span class="no">Logger</span><span class="o">::</span><span class="no">INFO</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span>

  <span class="c1"># Enable complex parameter support</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">support_complex_parameters!</span>

  <span class="c1"># Configure roots for filesystem access</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">roots</span> <span class="o">=</span> <span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">]</span> <span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">development?</span>

  <span class="c1"># Configure sampling (optional)</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">false</span> <span class="c1"># Set to true to enable</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">guard</span> <span class="k">do</span> <span class="o">|</span><span class="n">sample</span><span class="o">|</span>
    <span class="c1"># Add your sampling validation logic here</span>
    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Choose your client management strategy</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">launch_control</span> <span class="o">=</span> <span class="ss">:manual</span> <span class="c1"># or :automatic</span>

<span class="c1"># For automatic client management, uncomment:</span>
<span class="c1"># RubyLLM::MCP.launch_control = :automatic</span>
<span class="c1"># RubyLLM::MCP.start_all_clients</span>
</code></pre></div></div> <h4 id="configmcpsyml"> <a href="#configmcpsyml" class="anchor-heading" aria-labelledby="configmcpsyml"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <code class="language-plaintext highlighter-rouge">config/mcps.yml</code> </h4> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">mcp_servers</span><span class="pi">:</span>
  <span class="na">filesystem</span><span class="pi">:</span>
    <span class="na">transport_type</span><span class="pi">:</span> <span class="s">stdio</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">bunx</span>
    <span class="na">args</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">@modelcontextprotocol/server-filesystem"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">&lt;%=</span><span class="nv"> </span><span class="s">Rails.root</span><span class="nv"> </span><span class="s">%&gt;"</span>
    <span class="na">env</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">with_prefix</span><span class="pi">:</span> <span class="kc">true</span>

  <span class="c1"># Example SSE server</span>
  <span class="c1"># api_server:</span>
  <span class="c1">#   transport_type: sse</span>
  <span class="c1">#   url: "https://api.example.com/mcp/sse"</span>
  <span class="c1">#   headers:</span>
  <span class="c1">#     Authorization: "Bearer &lt;%= ENV['API_TOKEN'] %&gt;"</span>

  <span class="c1"># Example streamable HTTP server</span>
  <span class="c1"># http_server:</span>
  <span class="c1">#   transport_type: streamable</span>
  <span class="c1">#   url: "https://api.example.com/mcp"</span>
  <span class="c1">#   headers:</span>
  <span class="c1">#     Authorization: "Bearer &lt;%= ENV['API_TOKEN'] %&gt;"</span>
</code></pre></div></div> <h2 id="client-management-strategies"> <a href="#client-management-strategies" class="anchor-heading" aria-labelledby="client-management-strategies"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Client Management Strategies </h2> <h3 id="automatic-client-management"> <a href="#automatic-client-management" class="anchor-heading" aria-labelledby="automatic-client-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Automatic Client Management </h3> <p>For more basic use cases, you can run MCP clients and sub-processes directly along side your Rails application. Automatically starting clients is a good choice for most basic use cases, development, testing and getting started.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/ruby_llm_mcp.rb</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">launch_control</span> <span class="o">=</span> <span class="ss">:automatic</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">start_all_clients</span>

<span class="c1"># Clients are automatically available throughout the application</span>
<span class="n">clients</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">clients</span>
<span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="s2">"gpt-4"</span><span class="p">)</span>
<span class="n">chat</span><span class="p">.</span><span class="nf">with_tools</span><span class="p">(</span><span class="o">*</span><span class="n">clients</span><span class="p">.</span><span class="nf">tools</span><span class="p">)</span>
</code></pre></div></div> <h3 id="manual-client-management"> <a href="#manual-client-management" class="anchor-heading" aria-labelledby="manual-client-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manual Client Management </h3> <p>Due to the performace of LLMs, it’s likely that for production workloads you would want to that you will want to use LLM requests inside background job or streamable endpoints. Manual controller will give you more control over client connections and where they run.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/ruby_llm_mcp.rb</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">launch_control</span> <span class="o">=</span> <span class="ss">:manual</span>

<span class="c1"># In your application code</span>
<span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">do</span> <span class="o">|</span><span class="n">clients</span><span class="o">|</span>
  <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="s2">"gpt-4"</span><span class="p">)</span>
  <span class="n">chat</span><span class="p">.</span><span class="nf">with_tools</span><span class="p">(</span><span class="o">*</span><span class="n">clients</span><span class="p">.</span><span class="nf">tools</span><span class="p">)</span>

  <span class="n">response</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Analyze the project structure"</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="n">response</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="examples"> <a href="#examples" class="anchor-heading" aria-labelledby="examples"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Examples </h2> <h3 id="background-job-integration"> <a href="#background-job-integration" class="anchor-heading" aria-labelledby="background-job-integration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Background Job Integration </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MCPAnalysisJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="n">queue_as</span> <span class="ss">:default</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">do</span> <span class="o">|</span><span class="n">clients</span><span class="o">|</span>
      <span class="c1"># Add filesystem root for the project</span>
      <span class="n">clients</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span> <span class="n">client</span><span class="p">.</span><span class="nf">roots</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span> <span class="p">}</span>

      <span class="c1"># Create chat with tools</span>
      <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="s2">"gpt-4"</span><span class="p">)</span>
      <span class="n">chat</span><span class="p">.</span><span class="nf">with_tools</span><span class="p">(</span><span class="o">*</span><span class="n">clients</span><span class="p">.</span><span class="nf">tools</span><span class="p">)</span>

      <span class="c1"># Analyze the project</span>
      <span class="n">analysis</span> <span class="o">=</span> <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"Analyze the code structure and provide recommendations"</span><span class="p">)</span>

      <span class="c1"># Store results</span>
      <span class="no">AnalysisResult</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span>
        <span class="ss">project_path: </span><span class="n">project_path</span><span class="p">,</span>
        <span class="ss">analysis: </span><span class="n">analysis</span><span class="p">,</span>
        <span class="ss">completed_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span>
      <span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Usage</span>
<span class="no">MCPAnalysisJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="s2">"/path/to/project"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="advanced-job-with-progress-tracking"> <a href="#advanced-job-with-progress-tracking" class="anchor-heading" aria-labelledby="advanced-job-with-progress-tracking"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advanced Job with Progress Tracking </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AdvancedMCPJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="kp">include</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">url_helpers</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">task_params</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">do</span> <span class="o">|</span><span class="n">clients</span><span class="o">|</span>
      <span class="c1"># Setup progress tracking</span>
      <span class="n">setup_progress_tracking</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

      <span class="c1"># Configure roots based on user permissions</span>
      <span class="n">configure_user_roots</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

      <span class="c1"># Execute the task</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">execute_mcp_task</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">task_params</span><span class="p">)</span>

      <span class="c1"># Notify user of completion</span>
      <span class="n">notify_completion</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">setup_progress_tracking</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="n">clients</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span>
      <span class="n">client</span><span class="p">.</span><span class="nf">on_progress</span> <span class="k">do</span> <span class="o">|</span><span class="n">progress</span><span class="o">|</span>
        <span class="c1"># Broadcast progress via ActionCable</span>
        <span class="no">ActionCable</span><span class="p">.</span><span class="nf">server</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span>
          <span class="s2">"user_</span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">_progress"</span><span class="p">,</span>
          <span class="p">{</span> <span class="ss">progress: </span><span class="n">progress</span><span class="p">.</span><span class="nf">progress</span><span class="p">,</span> <span class="ss">message: </span><span class="n">progress</span><span class="p">.</span><span class="nf">message</span> <span class="p">}</span>
        <span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">configure_user_roots</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="c1"># Only allow access to user's projects</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">projects</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">project</span><span class="o">|</span>
      <span class="n">clients</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span> <span class="n">client</span><span class="p">.</span><span class="nf">roots</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">project</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute_mcp_task</span><span class="p">(</span><span class="n">clients</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="n">params</span><span class="p">[</span><span class="ss">:model</span><span class="p">]</span> <span class="o">||</span> <span class="s2">"gpt-4"</span><span class="p">)</span>
    <span class="n">chat</span><span class="p">.</span><span class="nf">with_tools</span><span class="p">(</span><span class="o">*</span><span class="n">clients</span><span class="p">.</span><span class="nf">tools</span><span class="p">)</span>

    <span class="c1"># Add user-specific context</span>
    <span class="n">chat</span><span class="p">.</span><span class="nf">with_resource</span><span class="p">(</span><span class="n">get_user_context_resource</span><span class="p">(</span><span class="n">clients</span><span class="p">))</span>

    <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:query</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_user_context_resource</span><span class="p">(</span><span class="n">clients</span><span class="p">)</span>
    <span class="c1"># Get a user-specific resource</span>
    <span class="n">clients</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">resource</span><span class="p">(</span><span class="s2">"user_preferences"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">notify_completion</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
    <span class="no">UserMailer</span><span class="p">.</span><span class="nf">mcp_task_completed</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">result</span><span class="p">).</span><span class="nf">deliver_now</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="controller-integration-for-basic-controller-usage"> <a href="#controller-integration-for-basic-controller-usage" class="anchor-heading" aria-labelledby="controller-integration-for-basic-controller-usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Controller Integration for Basic Controller Usage </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AnalysisController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">authorize_mcp_access!</span>

    <span class="n">result</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">do</span> <span class="o">|</span><span class="n">clients</span><span class="o">|</span>
      <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="n">params</span><span class="p">[</span><span class="ss">:model</span><span class="p">]</span> <span class="o">||</span> <span class="s2">"gpt-4"</span><span class="p">)</span>
      <span class="n">chat</span><span class="p">.</span><span class="nf">with_tools</span><span class="p">(</span><span class="o">*</span><span class="n">clients</span><span class="p">.</span><span class="nf">tools</span><span class="p">)</span>

      <span class="c1"># Add project context if specified</span>
      <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:project_id</span><span class="p">]</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">projects</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:project_id</span><span class="p">])</span>
        <span class="n">clients</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">client</span><span class="o">|</span> <span class="n">client</span><span class="p">.</span><span class="nf">roots</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">project</span><span class="p">.</span><span class="nf">path</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:query</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">analysis: </span><span class="n">result</span> <span class="p">}</span>
  <span class="k">rescue</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="o">::</span><span class="no">Error</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">error: </span><span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">authorize_mcp_access!</span>
    <span class="k">unless</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">can_use_mcp?</span>
      <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span> <span class="ss">error: </span><span class="s2">"MCP access not authorized"</span> <span class="p">},</span> <span class="ss">status: :forbidden</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="streaming-controller"> <a href="#streaming-controller" class="anchor-heading" aria-labelledby="streaming-controller"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Streaming Controller </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StreamingAnalysisController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'text/event-stream'</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">headers</span><span class="p">[</span><span class="s1">'Cache-Control'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'no-cache'</span>

    <span class="k">begin</span>
      <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="k">do</span> <span class="o">|</span><span class="n">clients</span><span class="o">|</span>
        <span class="n">chat</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="p">.</span><span class="nf">chat</span><span class="p">(</span><span class="ss">model: </span><span class="s2">"gpt-4"</span><span class="p">)</span>
        <span class="n">chat</span><span class="p">.</span><span class="nf">with_tools</span><span class="p">(</span><span class="o">*</span><span class="n">clients</span><span class="p">.</span><span class="nf">tools</span><span class="p">)</span>

        <span class="n">chat</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:query</span><span class="p">])</span> <span class="k">do</span> <span class="o">|</span><span class="n">chunk</span><span class="o">|</span>
          <span class="k">if</span> <span class="n">chunk</span><span class="p">.</span><span class="nf">tool_call?</span>
            <span class="c1"># Send tool usage information</span>
            <span class="n">chunk</span><span class="p">.</span><span class="nf">tool_calls</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">tool_call</span><span class="o">|</span>
              <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"data: </span><span class="si">#{</span><span class="n">json_event</span><span class="p">(</span><span class="ss">:tool_call</span><span class="p">,</span> <span class="p">{</span>
                <span class="ss">name: </span><span class="n">tool_call</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
                <span class="ss">parameters: </span><span class="n">tool_call</span><span class="p">.</span><span class="nf">parameters</span>
              <span class="si">}</span><span class="s2">)}</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">end</span>
          <span class="k">else</span>
            <span class="c1"># Send content chunk</span>
            <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"data: </span><span class="si">#{</span><span class="n">json_event</span><span class="p">(</span><span class="ss">:content</span><span class="p">,</span> <span class="p">{</span>
              <span class="ss">text: </span><span class="n">chunk</span><span class="p">.</span><span class="nf">content</span>
            <span class="si">}</span><span class="s2">)}</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"data: </span><span class="si">#{</span><span class="n">json_event</span><span class="p">(</span><span class="ss">:complete</span><span class="p">,</span> <span class="p">{</span><span class="si">}</span><span class="s2">)}</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s2">"data: </span><span class="si">#{</span><span class="n">json_event</span><span class="p">(</span><span class="ss">:error</span><span class="p">,</span> <span class="p">{</span>
        <span class="ss">message: </span><span class="n">e</span><span class="p">.</span><span class="nf">message</span>
      <span class="si">}</span><span class="s2">)}</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">ensure</span>
      <span class="n">response</span><span class="p">.</span><span class="nf">stream</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">json_event</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">type: </span><span class="n">type</span><span class="p">,</span> <span class="ss">data: </span><span class="n">data</span> <span class="p">}.</span><span class="nf">to_json</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="next-steps"> <a href="#next-steps" class="anchor-heading" aria-labelledby="next-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Steps </h2> <p>Now that you have comprehensive Rails integration set up:</p> <ol> <li><strong>Configure your MCP servers</strong> in <code class="language-plaintext highlighter-rouge">config/mcps.yml</code></li> <li><strong>Choose your client management strategy</strong> (manual vs automatic)</li> <li><strong>Implement MCP services</strong> for your specific use cases</li> <li><strong>Add proper error handling and monitoring</strong></li> <li><strong>Set up tests</strong> for your MCP integrations</li> </ol> <p>For more detailed information on specific topics:</p> <ul> <li><strong><a href="/configuration.html">Configuration</a></strong> - Advanced client configuration</li> <li><strong><a href="/server/tools.html">Tools</a></strong> - Working with MCP tools</li> <li><strong><a href="/server/resources.html">Resources</a></strong> - Managing resources and templates</li> <li><strong><a href="/server/notifications.html">Notifications</a></strong> - Handling real-time updates</li> </ul> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2025 <a href='https://patrickvice.com'>Patrick Vice</a>. Distributed under an <a href="https://github.com/patvice/ruby_llm-mcp/tree/main/LICENSE">MIT license.</a></p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
