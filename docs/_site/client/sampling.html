<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(1)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(5) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(5) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(5) > ul > li:nth-child(1) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/assets/images/favicon/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Sampling | RubyLLM::MCP</title> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Sampling" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="MCP sampling - allow servers to use your LLM for their own requests" /> <meta property="og:description" content="MCP sampling - allow servers to use your LLM for their own requests" /> <link rel="canonical" href="http://localhost:4000/client/sampling.html" /> <meta property="og:url" content="http://localhost:4000/client/sampling.html" /> <meta property="og:site_name" content="RubyLLM::MCP" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Sampling" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"MCP sampling - allow servers to use your LLM for their own requests","headline":"Sampling","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/rubyllm-mcp-logo-text.svg"}},"url":"http://localhost:4000/client/sampling.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> <div class="site-logo" role="img" aria-label="RubyLLM::MCP"></div> </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/configuration.html" class="nav-list-link">Configuration</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Guides category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/guides/" class="nav-list-link">Guides</a><ul class="nav-list"><li class="nav-list-item"><a href="/guides/getting-started.html" class="nav-list-link">Basics</a></li><li class="nav-list-item"><a href="/guides/rails-integration.html" class="nav-list-link">Rails Integration</a></li><li class="nav-list-item"><a href="/guides/transports.html" class="nav-list-link">Transports</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Server Interactions category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/server/" class="nav-list-link">Server Interactions</a><ul class="nav-list"><li class="nav-list-item"><a href="/server/tools.html" class="nav-list-link">Tools</a></li><li class="nav-list-item"><a href="/server/resources.html" class="nav-list-link">Resources</a></li><li class="nav-list-item"><a href="/server/prompts.html" class="nav-list-link">Prompts</a></li><li class="nav-list-item"><a href="/server/notifications.html" class="nav-list-link">Notifications</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Client Interactions category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/client/" class="nav-list-link">Client Interactions</a><ul class="nav-list"><li class="nav-list-item"><a href="/client/sampling.html" class="nav-list-link">Sampling</a></li><li class="nav-list-item"><a href="/client/roots.html" class="nav-list-link">Roots</a></li></ul></li></ul> <ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/patvice/ruby_llm-mcp" class="nav-list-link external" > Github <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search RubyLLM::MCP" aria-label="Search RubyLLM::MCP" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/client/">Client Interactions</a></li> <li class="breadcrumb-nav-list-item"><span>Sampling</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <h1 class="no_toc" id="sampling"> <a href="#sampling" class="anchor-heading" aria-labelledby="sampling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sampling </h1> <p>MCP sampling allows servers to offload LLM requests to your client rather than making them directly. This enables servers to use your LLM connections and configurations while maintaining their own logic and workflows.</p> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#overview" id="markdown-toc-overview">Overview</a></li> <li><a href="#basic-sampling-configuration" id="markdown-toc-basic-sampling-configuration">Basic Sampling Configuration</a> <ol> <li><a href="#enable-sampling" id="markdown-toc-enable-sampling">Enable Sampling</a></li> <li><a href="#basic-usage" id="markdown-toc-basic-usage">Basic Usage</a></li> </ol> </li> <li><a href="#model-selection" id="markdown-toc-model-selection">Model Selection</a> <ol> <li><a href="#static-model-selection" id="markdown-toc-static-model-selection">Static Model Selection</a></li> <li><a href="#dynamic-model-selection" id="markdown-toc-dynamic-model-selection">Dynamic Model Selection</a></li> <li><a href="#model-selection-based-on-request" id="markdown-toc-model-selection-based-on-request">Model Selection Based on Request</a></li> </ol> </li> <li><a href="#guards-and-filtering" id="markdown-toc-guards-and-filtering">Guards and Filtering</a> <ol> <li><a href="#basic-guards" id="markdown-toc-basic-guards">Basic Guards</a></li> <li><a href="#content-based-guards" id="markdown-toc-content-based-guards">Content-Based Guards</a></li> <li><a href="#rate-limiting-guards" id="markdown-toc-rate-limiting-guards">Rate Limiting Guards</a></li> <li><a href="#user-based-guards" id="markdown-toc-user-based-guards">User-Based Guards</a></li> </ol> </li> <li><a href="#next-steps" id="markdown-toc-next-steps">Next Steps</a></li> </ol><hr /> <h2 id="overview"> <a href="#overview" class="anchor-heading" aria-labelledby="overview"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview </h2> <p>When sampling is enabled, MCP servers can send “sample” requests to your client, which will:</p> <ol> <li>Execute the LLM request using your configured model</li> <li>Return the response back to the server</li> <li>Allow the server to continue its processing</li> </ol> <p>This is useful for servers that need LLM capabilities but don’t want to manage API keys or model connections directly.</p> <h2 id="basic-sampling-configuration"> <a href="#basic-sampling-configuration" class="anchor-heading" aria-labelledby="basic-sampling-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Sampling Configuration </h2> <h3 id="enable-sampling"> <a href="#enable-sampling" class="anchor-heading" aria-labelledby="enable-sampling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable Sampling </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>
<span class="k">end</span>

<span class="c1"># Create client with sampling enabled</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">client</span><span class="p">(</span>
  <span class="ss">name: </span><span class="s2">"sampling-server"</span><span class="p">,</span>
  <span class="ss">transport_type: :stdio</span><span class="p">,</span>
  <span class="ss">config: </span><span class="p">{</span>
    <span class="ss">command: </span><span class="s2">"bunx"</span><span class="p">,</span>
    <span class="ss">args: </span><span class="p">[</span><span class="s2">"@example/mcp-server-with-sampling"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div> <h3 id="basic-usage"> <a href="#basic-usage" class="anchor-heading" aria-labelledby="basic-usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Usage </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The server can now make sampling requests</span>
<span class="c1"># These will be automatically handled by your client</span>
<span class="n">tool</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">tool</span><span class="p">(</span><span class="s2">"analyze_data"</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tool</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="ss">data: </span><span class="s2">"some data to analyze"</span><span class="p">)</span>

<span class="c1"># Behind the scenes, the server may have made LLM requests</span>
<span class="c1"># using your configured model and API credentials</span>
<span class="nb">puts</span> <span class="n">result</span>
</code></pre></div></div> <h2 id="model-selection"> <a href="#model-selection" class="anchor-heading" aria-labelledby="model-selection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Model Selection </h2> <h3 id="static-model-selection"> <a href="#static-model-selection" class="anchor-heading" aria-labelledby="static-model-selection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Static Model Selection </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>
<span class="k">end</span>

<span class="c1"># All sampling requests will use GPT-4</span>
</code></pre></div></div> <h3 id="dynamic-model-selection"> <a href="#dynamic-model-selection" class="anchor-heading" aria-labelledby="dynamic-model-selection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Dynamic Model Selection </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Use a block for dynamic model selection</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_preferences</span><span class="o">|</span>
    <span class="c1"># The server can send model preferences/hints</span>
    <span class="n">server_preference</span> <span class="o">=</span> <span class="n">model_preferences</span><span class="p">.</span><span class="nf">hints</span><span class="p">.</span><span class="nf">first</span>

    <span class="c1"># You can use server preferences or override them</span>
    <span class="k">case</span> <span class="n">server_preference</span>
    <span class="k">when</span> <span class="s2">"fast"</span>
      <span class="s2">"gpt-3.5-turbo"</span>
    <span class="k">when</span> <span class="s2">"smart"</span>
      <span class="s2">"gpt-4"</span>
    <span class="k">when</span> <span class="s2">"coding"</span>
      <span class="s2">"gpt-4"</span>
    <span class="k">else</span>
      <span class="s2">"gpt-4"</span> <span class="c1"># Default fallback</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="model-selection-based-on-request"> <a href="#model-selection-based-on-request" class="anchor-heading" aria-labelledby="model-selection-based-on-request"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Model Selection Based on Request </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="k">do</span> <span class="o">|</span><span class="n">model_preferences</span><span class="o">|</span>
    <span class="c1"># Access the full sampling request context</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">model_preferences</span><span class="p">.</span><span class="nf">messages</span>

    <span class="c1"># Choose model based on message content</span>
    <span class="k">if</span> <span class="n">messages</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="n">msg</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"code"</span><span class="p">)</span> <span class="p">}</span>
      <span class="s2">"gpt-4"</span> <span class="c1"># Use GPT-4 for code-related tasks</span>
    <span class="k">elsif</span> <span class="n">messages</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">10</span>
      <span class="s2">"gpt-3.5-turbo"</span> <span class="c1"># Use faster model for long conversations</span>
    <span class="k">else</span>
      <span class="s2">"gpt-4"</span> <span class="c1"># Default for other cases</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="guards-and-filtering"> <a href="#guards-and-filtering" class="anchor-heading" aria-labelledby="guards-and-filtering"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Guards and Filtering </h2> <h3 id="basic-guards"> <a href="#basic-guards" class="anchor-heading" aria-labelledby="basic-guards"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Guards </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>

  <span class="c1"># Only allow samples that contain "Hello"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">guard</span> <span class="k">do</span> <span class="o">|</span><span class="n">sample</span><span class="o">|</span>
    <span class="n">sample</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="n">msg</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="content-based-guards"> <a href="#content-based-guards" class="anchor-heading" aria-labelledby="content-based-guards"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Content-Based Guards </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>

  <span class="c1"># Filter based on message content</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">guard</span> <span class="k">do</span> <span class="o">|</span><span class="n">sample</span><span class="o">|</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">sample</span><span class="p">.</span><span class="nf">messages</span>

    <span class="c1"># Don't allow requests containing sensitive keywords</span>
    <span class="n">sensitive_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"password"</span><span class="p">,</span> <span class="s2">"secret"</span><span class="p">,</span> <span class="s2">"private_key"</span><span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">none?</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
      <span class="n">sensitive_keywords</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span> <span class="o">|</span><span class="n">keyword</span><span class="o">|</span> <span class="n">message</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="rate-limiting-guards"> <a href="#rate-limiting-guards" class="anchor-heading" aria-labelledby="rate-limiting-guards"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Rate Limiting Guards </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SamplingRateLimiter</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">max_requests: </span><span class="mi">100</span><span class="p">,</span> <span class="ss">window: </span><span class="mi">3600</span><span class="p">)</span>
    <span class="vi">@max_requests</span> <span class="o">=</span> <span class="n">max_requests</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="n">window</span>
    <span class="vi">@requests</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">allow_request?</span>
    <span class="n">now</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>

    <span class="c1"># Remove old requests outside the window</span>
    <span class="vi">@requests</span><span class="p">.</span><span class="nf">reject!</span> <span class="p">{</span> <span class="o">|</span><span class="n">timestamp</span><span class="o">|</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="vi">@window</span> <span class="p">}</span>

    <span class="c1"># Check if we're under the limit</span>
    <span class="k">if</span> <span class="vi">@requests</span><span class="p">.</span><span class="nf">length</span> <span class="o">&lt;</span> <span class="vi">@max_requests</span>
      <span class="vi">@requests</span> <span class="o">&lt;&lt;</span> <span class="n">now</span>
      <span class="kp">true</span>
    <span class="k">else</span>
      <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">rate_limiter</span> <span class="o">=</span> <span class="no">SamplingRateLimiter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">max_requests: </span><span class="mi">50</span><span class="p">,</span> <span class="ss">window: </span><span class="mi">3600</span><span class="p">)</span>

<span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">guard</span> <span class="k">do</span> <span class="o">|</span><span class="n">sample</span><span class="o">|</span>
    <span class="n">rate_limiter</span><span class="p">.</span><span class="nf">allow_request?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="user-based-guards"> <a href="#user-based-guards" class="anchor-heading" aria-labelledby="user-based-guards"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> User-Based Guards </h3> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RubyLLM</span><span class="o">::</span><span class="no">MCP</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">preferred_model</span> <span class="o">=</span> <span class="s2">"gpt-4"</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">sampling</span><span class="p">.</span><span class="nf">guard</span> <span class="k">do</span> <span class="o">|</span><span class="n">sample</span><span class="o">|</span>
    <span class="c1"># Check if user is authorized (if server provides user context)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">sample</span><span class="p">.</span><span class="nf">metadata</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s2">"user_id"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_id</span>
      <span class="c1"># Check user permissions</span>
      <span class="n">authorized_users</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"user1"</span><span class="p">,</span> <span class="s2">"user2"</span><span class="p">,</span> <span class="s2">"admin"</span><span class="p">]</span>
      <span class="n">authorized_users</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="c1"># Allow anonymous requests</span>
      <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="next-steps"> <a href="#next-steps" class="anchor-heading" aria-labelledby="next-steps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Steps </h2> <ul> <li><strong><a href="/client/roots.html">Roots</a></strong> - Provide filesystem access to servers</li> <li><strong><a href="/guides/rails-integration.html">Rails Integration</a></strong> - Complete Rails integration guide</li> </ul> </main> <hr> <footer> <p><a href="#top" id="back-to-top">Back to top</a></p> <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2025 <a href='https://patrickvice.com'>Patrick Vice</a>. Distributed under an <a href="https://github.com/patvice/ruby_llm-mcp/tree/main/LICENSE">MIT license.</a></p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
